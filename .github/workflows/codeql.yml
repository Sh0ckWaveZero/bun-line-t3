# ğŸ” CodeQL Security Analysis Workflow
# GitHub Advanced Security à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¸‚à¸­à¸‡à¹‚à¸„à¹‰à¸”

name: ğŸ” CodeQL Security Analysis

on:
  push:
    branches: ["main", "develop", "feature/*"]
    paths-ignore:
      - tests/**
      - **/tests/**
      - **/*.test.*
      - **/*.spec.*
      - docs/**
      - *.md
      - .vscode/**
      - .github/**
      - '!.github/workflows/codeql.yml'
  pull_request:
    branches: ["main", "develop"]
    paths-ignore:
      - tests/**
      - **/tests/**
      - **/*.test.*
      - **/*.spec.*
      - docs/**
      - *.md
      - .vscode/**
      - .github/**
      - '!.github/workflows/codeql.yml'
  schedule:
    # à¸—à¸³à¸à¸²à¸£ scan à¸—à¸¸à¸à¸§à¸±à¸™à¸ˆà¸±à¸™à¸—à¸£à¹Œà¹€à¸§à¸¥à¸² 02:00 UTC (09:00 à¹€à¸§à¸¥à¸²à¹„à¸—à¸¢)
    - cron: "0 2 * * 1"

jobs:
  analyze:
    name: ğŸ” CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      # à¸ˆà¸³à¹€à¸›à¹‡à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£ checkout repository
      contents: read
      # à¸ˆà¸³à¹€à¸›à¹‡à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¹„à¸›à¸¢à¸±à¸‡ GitHub Security tab
      security-events: write
      # à¸ˆà¸³à¹€à¸›à¹‡à¸™à¹€à¸‰à¸à¸²à¸°à¹ƒà¸™à¸à¸£à¸“à¸µà¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™ private repository
      actions: read

    strategy:
      fail-fast: false
      matrix:
        # CodeQL à¸£à¸­à¸‡à¸£à¸±à¸š: c-cpp, csharp, go, java-kotlin, javascript-typescript, python, ruby, swift
        # à¹ƒà¸Šà¹‰ javascript-typescript à¸ªà¸³à¸«à¸£à¸±à¸š Next.js + TypeScript project
        language: ['javascript-typescript']

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install Dependencies
        run: |
          bun install --frozen-lockfile
          
      - name: ğŸ—ï¸ Build Project
        run: |
          # à¸ªà¸£à¹‰à¸²à¸‡ output.css à¸ªà¸³à¸«à¸£à¸±à¸š Tailwind
          bun run tailwind:build
          # Build Next.js project
          bun run build
        env:
          # à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² environment variables à¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™à¸ªà¸³à¸«à¸£à¸±à¸š build
          NODE_ENV: production
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'dummy-secret-for-analysis' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'mongodb://localhost:27017/dummy' }}

      - name: ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # à¸£à¸°à¸šà¸¸ query suites à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢
          queries: +security-and-quality

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          # à¸£à¸­à¹€à¸§à¸¥à¸²à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 20 à¸™à¸²à¸—à¸µà¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ
          wait-for-processing: true

      - name: ğŸš¨ Security Summary
        if: always()
        run: |
          echo "ğŸ” CodeQL Security Analysis à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™"
          echo "ğŸ“Š à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸ˆà¸°à¸›à¸£à¸²à¸à¸à¹ƒà¸™ Security tab à¸‚à¸­à¸‡ repository"
          echo "ğŸ›¡ï¸ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š Security Advisories à¸«à¸²à¸à¸à¸š vulnerabilities"
