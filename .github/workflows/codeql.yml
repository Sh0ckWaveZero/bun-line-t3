# 🔍 CodeQL Security Analysis Workflow
# GitHub Advanced Security สำหรับการวิเคราะห์ความปลอดภัยของโค้ด

name: 🔍 CodeQL Security Analysis

on:
  push:
    branches: ["main", "develop", "feature/*"]
    paths-ignore:
      - tests/**
      - **/tests/**
      - **/*.test.*
      - **/*.spec.*
      - docs/**
      - *.md
      - .vscode/**
      - .github/**
      - '!.github/workflows/codeql.yml'
  pull_request:
    branches: ["main", "develop"]
    paths-ignore:
      - tests/**
      - **/tests/**
      - **/*.test.*
      - **/*.spec.*
      - docs/**
      - *.md
      - .vscode/**
      - .github/**
      - '!.github/workflows/codeql.yml'
  schedule:
    # ทำการ scan ทุกวันจันทร์เวลา 02:00 UTC (09:00 เวลาไทย)
    - cron: "0 2 * * 1"

jobs:
  analyze:
    name: 🔍 CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      # จำเป็นสำหรับการ checkout repository
      contents: read
      # จำเป็นสำหรับการอัปโหลดผลลัพธ์ไปยัง GitHub Security tab
      security-events: write
      # จำเป็นเฉพาะในกรณีที่เป็น private repository
      actions: read

    strategy:
      fail-fast: false
      matrix:
        # CodeQL รองรับ: c-cpp, csharp, go, java-kotlin, javascript-typescript, python, ruby, swift
        # ใช้ javascript-typescript สำหรับ Next.js + TypeScript project
        language: ['javascript-typescript']

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔧 Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: 📦 Install Dependencies
        run: |
          bun install --frozen-lockfile
          
      - name: 🏗️ Build Project
        run: |
          # สร้าง output.css สำหรับ Tailwind
          bun run tailwind:build
          # Build Next.js project
          bun run build
        env:
          # ตั้งค่า environment variables ที่จำเป็นสำหรับ build
          NODE_ENV: production
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'dummy-secret-for-analysis' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'mongodb://localhost:27017/dummy' }}

      - name: 🔍 Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # ระบุ query suites สำหรับการวิเคราะห์ความปลอดภัย
          queries: +security-and-quality

      - name: 🔍 Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          # รอเวลาสูงสุด 20 นาทีสำหรับการวิเคราะห์
          wait-for-processing: true

      - name: 🚨 Security Summary
        if: always()
        run: |
          echo "🔍 CodeQL Security Analysis เสร็จสิ้น"
          echo "📊 ผลลัพธ์จะปรากฏใน Security tab ของ repository"
          echo "🛡️ ตรวจสอบ Security Advisories หากพบ vulnerabilities"
