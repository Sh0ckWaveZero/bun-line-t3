# üöÄ GitHub Actions Deployment Workflow
# ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Self-Hosted Runner (Raspberry Pi) ‡πÅ‡∏•‡∏∞ GitHub Secrets Management

name: üöÄ Deploy to Production

on:
  push:
    branches: [main, production]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".vscode/**"

  # Manual deployment trigger ‡∏û‡∏£‡πâ‡∏≠‡∏° options
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild Docker images"
        required: false
        default: false
        type: boolean
      skip_health_checks:
        description: "Skip health checks (for emergency deployments)"
        required: false
        default: false
        type: boolean
      environment:
        description: "Target environment"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

# üîê Security: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î permissions ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≥‡∏Å‡∏±‡∏î
permissions:
  contents: read
  actions: read
  security-events: write

# üõ°Ô∏è Environment Variables: ‡∏à‡∏≤‡∏Å GitHub Secrets ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ timezone ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö logs
  TZ: Asia/Bangkok

jobs:
  # Job 1: Security ‡πÅ‡∏•‡∏∞ Environment Validation
  security-check:
    name: üîê Security & Environment Validation
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üîç Validate Required Secrets
        run: |
          echo "üîê ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GitHub Secrets ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô..."

          REQUIRED_SECRETS=(
            "DATABASE_URL"
            "NEXTAUTH_URL" 
            "NEXTAUTH_SECRET"
            "JWT_SECRET"
            "INTERNAL_API_KEY"
            "CRON_SECRET"
            "LINE_CLIENT_ID"
            "LINE_CLIENT_SECRET"
            "LINE_LOGIN_CHANNEL_ID"
            "LINE_LOGIN_CHANNEL_SECRET"
            "LINE_CHANNEL_ACCESS"
            "LINE_CHANNEL_SECRET"
            "AIRVISUAL_API_KEY"
            "CMC_API_KEY"
            "OPENAI_API_KEY"
          )

          MISSING_SECRETS=()

          for secret in "${REQUIRED_SECRETS[@]}"; do
            if [[ -z "${!secret}" ]]; then
              MISSING_SECRETS+=("$secret")
            fi
          done

          if [[ ${#MISSING_SECRETS[@]} -gt 0 ]]; then
            echo "‚ùå Missing required secrets:"
            printf '%s\n' "${MISSING_SECRETS[@]}"
            echo "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GitHub Secrets ‡πÉ‡∏ô Repository Settings"
            exit 1
          fi

          echo "‚úÖ All required secrets are configured"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          INTERNAL_API_KEY: ${{ secrets.INTERNAL_API_KEY }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          LINE_CLIENT_ID: ${{ secrets.LINE_CLIENT_ID }}
          LINE_CLIENT_SECRET: ${{ secrets.LINE_CLIENT_SECRET }}
          LINE_LOGIN_CHANNEL_ID: ${{ secrets.LINE_LOGIN_CHANNEL_ID }}
          LINE_LOGIN_CHANNEL_SECRET: ${{ secrets.LINE_LOGIN_CHANNEL_SECRET }}
          LINE_CHANNEL_ACCESS: ${{ secrets.LINE_CHANNEL_ACCESS }}
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
          AIRVISUAL_API_KEY: ${{ secrets.AIRVISUAL_API_KEY }}
          CMC_API_KEY: ${{ secrets.CMC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: üñ•Ô∏è System Resource Check
        run: |
          echo "üñ•Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö system resources..."

          # Memory check
          AVAILABLE_MEMORY=$(free -m | awk 'NR==2{printf "%.0f", $7}')
          REQUIRED_MEMORY=1024

          if [[ $AVAILABLE_MEMORY -lt $REQUIRED_MEMORY ]]; then
            echo "‚ö†Ô∏è Warning: Available memory: ${AVAILABLE_MEMORY}MB (recommended: ${REQUIRED_MEMORY}MB+)"
          else
            echo "‚úÖ Memory: ${AVAILABLE_MEMORY}MB available"
          fi

          # Disk space check
          AVAILABLE_DISK=$(df -BM /var/lib/docker 2>/dev/null | awk 'NR==2{print $4}' | sed 's/M//' || echo "1000")
          REQUIRED_DISK=2048

          if [[ $AVAILABLE_DISK -lt $REQUIRED_DISK ]]; then
            echo "‚ùå Insufficient disk space: ${AVAILABLE_DISK}MB (required: ${REQUIRED_DISK}MB+)"
            exit 1
          else
            echo "‚úÖ Disk space: ${AVAILABLE_DISK}MB available"
          fi

          # Docker service check
          if ! systemctl is-active --quiet docker; then
            echo "‚ùå Docker service is not running"
            exit 1
          fi
          echo "‚úÖ Docker service is running"

      - name: üßπ Pre-deployment Cleanup
        run: |
          echo "üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° deployment..."

          # ‡∏•‡∏ö dangling images ‡πÅ‡∏•‡∏∞ unused volumes
          docker image prune -f || true
          docker volume prune -f || true

          # ‡∏•‡∏ö build cache ‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
          docker builder prune --filter "until=24h" -f || true

          echo "‚úÖ Cleanup completed"

  # Job 2: Build ‡πÅ‡∏•‡∏∞ Deploy
  deploy:
    name: üöÄ Build & Deploy Application
    runs-on: self-hosted
    needs: security-check
    timeout-minutes: 30

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: üîß Setup Environment File
        run: |
          echo "üîß ‡∏™‡∏£‡πâ‡∏≤‡∏á .env.prod ‡∏à‡∏≤‡∏Å GitHub Secrets..."

          cat > .env.prod << EOF
          # =============================================================================
          # Environment Configuration (Generated from GitHub Secrets)
          # Generated at: $(date -Iseconds)
          # Commit: ${{ github.sha }}
          # =============================================================================

          # Application Environment
          APP_ENV=production
          NEXT_PUBLIC_APP_ENV=production
          HOSTNAME=localhost
          PORT=${{ secrets.PORT || '12914' }}
          FRONTEND_URL="${{ secrets.NEXTAUTH_URL }}/"

          # =============================================================================
          # Authentication & Security
          # =============================================================================

          # NextAuth Configuration
          NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"
          NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          JWT_EXPIRES_IN=18144000000

          # Internal API Security
          INTERNAL_API_KEY="${{ secrets.INTERNAL_API_KEY }}"

          # Cron Job Security
          CRON_SECRET="${{ secrets.CRON_SECRET }}"

          # =============================================================================
          # LINE Integration
          # =============================================================================

          # LINE Login Provider
          LINE_CLIENT_ID="${{ secrets.LINE_CLIENT_ID }}"
          LINE_CLIENT_SECRET="${{ secrets.LINE_CLIENT_SECRET }}"
          LINE_LOGIN_CHANNEL_ID="${{ secrets.LINE_LOGIN_CHANNEL_ID }}"
          LINE_LOGIN_CHANNEL_SECRET="${{ secrets.LINE_LOGIN_CHANNEL_SECRET }}"

          # LINE Messaging API
          LINE_CHANNEL_ACCESS="${{ secrets.LINE_CHANNEL_ACCESS }}"
          LINE_MESSAGING_API=https://api.line.me/v2/bot/message
          LINE_GET_CONTENT=https://api-data.line.me/v2/bot/message
          LINE_CHANNEL_SECRET="${{ secrets.LINE_CHANNEL_SECRET }}"

          # =============================================================================
          # Database Configuration
          # =============================================================================

          # MongoDB
          MONGODB_URI="${{ secrets.DATABASE_URL }}"
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          DB_NAME=linebot

          # =============================================================================
          # External API Keys
          # =============================================================================

          # Air Quality Monitoring
          AIRVISUAL_API_KEY="${{ secrets.AIRVISUAL_API_KEY }}"

          # Cryptocurrency Market Data
          CMC_API_KEY="${{ secrets.CMC_API_KEY }}"
          CMC_URL=https://pro-api.coinmarketcap.com

          # OpenAI API
          OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          EOF

          # Set secure permissions
          chmod 600 .env.prod
          echo "‚úÖ Environment file created with secure permissions"

      - name: üõë Stop Existing Services
        run: |
          echo "üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà..."

          if docker-compose ps | grep -q "Up"; then
            echo "Stopping existing services..."
            docker-compose down --timeout 30
          else
            echo "No running services found"
          fi

      - name: üèóÔ∏è Build Application
        run: |
          echo "üèóÔ∏è Building application..."

          # Force rebuild ‡∏ñ‡πâ‡∏≤ manual trigger ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
          BUILD_ARGS=""
          if [[ "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
            echo "üîÑ Force rebuild enabled - pulling base images..."
            BUILD_ARGS="--pull --no-cache"
          fi

          docker-compose build $BUILD_ARGS

          echo "‚úÖ Build completed successfully"

      - name: üöÄ Start Services
        run: |
          echo "üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£..."

          # Start services in production mode
          docker-compose up -d

          echo "‚úÖ Services started successfully"
        env:
          # Override environment variables ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö docker-compose
          PORT: ${{ secrets.PORT || '12914' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          INTERNAL_API_KEY: ${{ secrets.INTERNAL_API_KEY }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          LINE_CLIENT_ID: ${{ secrets.LINE_CLIENT_ID }}
          LINE_CLIENT_SECRET: ${{ secrets.LINE_CLIENT_SECRET }}
          LINE_LOGIN_CHANNEL_ID: ${{ secrets.LINE_LOGIN_CHANNEL_ID }}
          LINE_LOGIN_CHANNEL_SECRET: ${{ secrets.LINE_LOGIN_CHANNEL_SECRET }}
          LINE_CHANNEL_ACCESS: ${{ secrets.LINE_CHANNEL_ACCESS }}
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
          AIRVISUAL_API_KEY: ${{ secrets.AIRVISUAL_API_KEY }}
          CMC_API_KEY: ${{ secrets.CMC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: üîê Security Cleanup
        if: always()
        run: |
          echo "üîê ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç..."

          # ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå environment variables ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
          if [[ -f .env.prod ]]; then
            shred -vfz -n 3 .env.prod
            echo "‚úÖ Environment file securely deleted"
          fi

          # ‡∏•‡πâ‡∏≤‡∏á environment variables ‡∏à‡∏≤‡∏Å shell history
          unset DATABASE_URL NEXTAUTH_SECRET LINE_CHANNEL_SECRET LINE_CHANNEL_ACCESS_TOKEN
          unset AIRVISUAL_API_KEY CMC_API_KEY ENCRYPTION_KEY HMAC_SECRET

          echo "‚úÖ Security cleanup completed"

  # Job 3: Health Checks ‡πÅ‡∏•‡∏∞ Monitoring
  monitor:
    name: üè• Health Checks & Monitoring
    runs-on: self-hosted
    needs: deploy
    timeout-minutes: 10
    if: github.event.inputs.skip_health_checks != 'true'

    steps:
      - name: ‚è±Ô∏è Wait for Service Startup
        run: |
          echo "‚è±Ô∏è ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô..."
          sleep 30

      - name: üè• Application Health Check
        run: |
          echo "üè• ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô..."

          HEALTH_URL="http://localhost:${{ secrets.PORT || '12914' }}/api/health"
          MAX_ATTEMPTS=10
          ATTEMPT=1

          while [[ $ATTEMPT -le $MAX_ATTEMPTS ]]; do
            echo "Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            if curl -f -s -m 10 "$HEALTH_URL" > /dev/null; then
              echo "‚úÖ Application is healthy"
              break
            else
              if [[ $ATTEMPT -eq $MAX_ATTEMPTS ]]; then
                echo "‚ùå Application health check failed after $MAX_ATTEMPTS attempts"
                docker-compose logs --tail=50
                exit 1
              fi
              echo "‚è≥ Waiting 10 seconds before retry..."
              sleep 10
              ((ATTEMPT++))
            fi
          done

      - name: üîç Service Status Check
        run: |
          echo "üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£..."

          # Check container status
          if ! docker-compose ps | grep -E "(Up|healthy)"; then
            echo "‚ùå Services are not running properly"
            docker-compose logs --tail=100
            exit 1
          fi

          echo "‚úÖ All services are running"

      - name: üìä Resource Usage Report
        run: |
          echo "üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£..."

          echo "=== Docker Container Stats ==="
          docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"

          echo "=== System Resource Usage ==="
          echo "Memory Usage:"
          free -h

          echo "Disk Usage:"
          df -h /var/lib/docker

          echo "‚úÖ Resource report completed"

      - name: üìù Deployment Summary
        run: |
          echo "üìù ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£ deployment..."

          echo "üéâ Deployment completed successfully!"
          echo "üìÖ Deployed at: $(date -Iseconds)"
          echo "üîñ Commit: ${{ github.sha }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üë§ Triggered by: ${{ github.actor }}"
          echo "üîó Application URL: ${{ secrets.NEXTAUTH_URL }}"

          # Container information
          echo "üê≥ Running containers:"
          docker-compose ps --format "table {{.Name}}\t{{.State}}\t{{.Ports}}"

  # Job 4: Post-deployment Verification (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ production)
  verify:
    name: ‚úÖ Post-deployment Verification
    runs-on: self-hosted
    needs: monitor
    timeout-minutes: 5
    if: github.ref == 'refs/heads/main' && github.event.inputs.skip_health_checks != 'true'

    steps:
      - name: üîç LINE Bot Health Check
        run: |
          echo "üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û LINE Bot..."

          # Test webhook endpoint (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ test endpoint)
          WEBHOOK_URL="http://localhost:${{ secrets.PORT || '12914' }}/api/line"

          if curl -f -s -m 10 -X POST "$WEBHOOK_URL" \
             -H "Content-Type: application/json" \
             -d '{"events":[],"destination":"test"}' > /dev/null; then
            echo "‚úÖ LINE Bot webhook is responsive"
          else
            echo "‚ö†Ô∏è LINE Bot webhook test failed (may be normal for production)"
          fi

      - name: üìß Notification (Future Enhancement)
        run: |
          echo "üìß ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô deployment ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à..."
          echo "‚ÑπÔ∏è ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (LINE Notify, Slack, etc.)"
