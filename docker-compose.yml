version: '3.8'

# üõ°Ô∏è SECURITY-FIRST Docker Compose ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Bun + Next.js + Prisma
# ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ï‡∏≤‡∏° Docker Security Best Practices

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64  # Force AMD64 for better performance
      args:
        - BUILDKIT_INLINE_CACHE=1
      target: runner
    container_name: bun-line-t3-app
    ports:
      - "12914:12914"  # ‡πÉ‡∏ä‡πâ PORT ‡∏à‡∏≤‡∏Å .env.prod
    env_file:
      - .env.prod
    restart: unless-stopped    
    # üõ°Ô∏è SECURITY: Health check ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:12914/api/health"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 20s  # ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤ Prisma ‡πÅ‡∏•‡∏∞‡πÅ‡∏≠‡∏õ‡∏Ø ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    
    # üîê SECURITY: Security ‡πÅ‡∏•‡∏∞ resource limits
    security_opt:
      - no-new-privileges:true
    read_only: false  # Next.js standalone ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    tmpfs:
      - /tmp:rw,size=100m,mode=1777
      - /var/tmp:rw,size=50m,mode=1777

    
    # üîê SECURITY: Network isolation - ‡πÉ‡∏ä‡πâ yadom network ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    networks:
      - yadom

  cron:
    build:
      context: .
      dockerfile: Dockerfile.cron
      args:
        - BUILDKIT_INLINE_CACHE=1
    container_name: bun-line-t3-cron
    env_file:
      - .env.prod
    restart: unless-stopped
    # üõ°Ô∏è SECURITY: ‡∏£‡∏≠‡πÉ‡∏´‡πâ app service ‡∏ú‡πà‡∏≤‡∏ô health check ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° cron
    depends_on:
      app:
        condition: service_healthy
    
    # üîê SECURITY: Security ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö cron service
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:rw,size=50m,mode=1777

    # üîê SECURITY: Network isolation - ‡πÉ‡∏ä‡πâ yadom network ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    networks:
      - yadom

# üîê SECURITY: Network configuration ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Raspberry Pi deployment
networks:
  yadom:
    external: true  # ‡πÉ‡∏ä‡πâ network yadom ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
