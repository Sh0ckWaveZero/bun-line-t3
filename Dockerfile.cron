# Dockerfile.cron
# üîß Multi-platform support for ARM64 (Raspberry Pi) ‡πÅ‡∏•‡∏∞ AMD64

# ‡πÉ‡∏ä‡πâ base image ‡∏ó‡∏µ‡πà‡∏°‡∏µ cron ‡πÅ‡∏•‡∏∞ curl (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API endpoint)
# Alpine ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡πÅ‡∏•‡∏∞‡∏°‡∏µ cron (busybox-cron)
FROM --platform=$TARGETPLATFORM alpine:latest

# üîß Multi-platform build arguments
ARG TARGETPLATFORM
ARG BUILDPLATFORM
RUN echo "Building cron service on $BUILDPLATFORM for $TARGETPLATFORM"

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á curl ‡πÅ‡∏•‡∏∞ ca-certificates (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö HTTPS)
RUN apk add --no-cache curl ca-certificates tzdata

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Timezone (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö cron jobs)
# TZ ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å .env.prod ‡∏ú‡πà‡∏≤‡∏ô docker-compose.yml
# Default ‡πÄ‡∏õ‡πá‡∏ô Asia/Bangkok ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô environment
ENV TZ=Asia/Bangkok
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πÄ‡∏£‡∏Å‡∏ó‡∏≠‡∏£‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö cron scripts
WORKDIR /app

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å crontab file ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
COPY crontab /etc/crontabs/root

# ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå execute ‡∏Å‡∏±‡∏ö crontab (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö busybox-cron ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢)
# RUN chmod 0644 /etc/crontabs/root

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å script ‡∏ó‡∏µ‡πà cron job ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
# ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ô‡∏µ‡πâ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ curl ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API endpoint ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å crontab
# COPY scripts/checkout-reminder-cron.sh /usr/local/bin/checkout-reminder-cron.sh
# RUN chmod +x /usr/local/bin/checkout-reminder-cron.sh

# ‡∏£‡∏±‡∏ô cron daemon ‡πÉ‡∏ô foreground
CMD ["crond", "-f", "-d", "8"]
